#!/usr/bin/env node

const fs = require("fs-jetpack");
const path = require("path");
const { sortBy } = require("lodash");
const handlebars = require("handlebars");
const docgen = require("react-docgen-typescript");

/**
 * Define helper methods
 */
handlebars.registerHelper({
  markdown(value) {
    return value.replace(/\|/g, "\\|").replace(/\n/g, "<br>");
  }
});

/**
 * Load the template
 */
const source = fs.read("docs.hbs", "utf8");
const template = handlebars.compile(source, {
  noEscape: true
});

/**
 * Render a template
 */
const render = (file, component) => {
  const props = sortBy(component.props, [
    prop => !prop.required,
    prop => prop.name
  ]);

  return template({ ...component, props });
};

/**
 * Get the appropriate docs directory for a file
 */
const getDocsDir = file => {
  const segments = file.split(path.sep);
  const srcIndex = segments.indexOf("src");

  segments[srcIndex] = "docs";
  segments.splice(srcIndex + 1);

  return segments.join(path.sep);
};

/**
 * Generate documentation for a file
 */
const generate = file => {
  const docsDir = getDocsDir(file);

  docgen.parse(file).forEach(component => {
    const basename = `${component.displayName}.md`;
    const filename = path.join(docsDir, basename);
    const content = render(file, component);

    fs.file(filename, { content });
  });
};

const docFiles = fs.find("packages", { matching: "*/docs/*.md" });
const sourceFiles = fs.find("packages", { matching: "*/src/index.{ts,tsx}" });

docFiles.forEach(file => fs.remove(file));
sourceFiles.forEach(generate);
